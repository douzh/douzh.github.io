<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>区块链python示例 | OneKBase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="在开始之前，我们需要做些准备工作，搞清楚一些问题。 什么是区块链？区块链是由不可变的、有顺序记录的区块组成。他们可以包含交易数据、文件数据或者其他你想要记录的数据。不过最重要的是这些区块通过哈希表链接在一起。 什么是散列？散列函数是一个输入值函数，从该输入创建一个确定输入值的输出值。 这篇文章适合谁，首先Python程序员，你只要能轻松地读写一些基本的Python代码就可以了；第二是HTTP程序员">
<meta property="og:type" content="article">
<meta property="og:title" content="区块链python示例">
<meta property="og:url" content="http://www.onekbase.com/blog/arch/blockchain/pythondemo/index.html">
<meta property="og:site_name" content="OneKBase">
<meta property="og:description" content="在开始之前，我们需要做些准备工作，搞清楚一些问题。 什么是区块链？区块链是由不可变的、有顺序记录的区块组成。他们可以包含交易数据、文件数据或者其他你想要记录的数据。不过最重要的是这些区块通过哈希表链接在一起。 什么是散列？散列函数是一个输入值函数，从该输入创建一个确定输入值的输出值。 这篇文章适合谁，首先Python程序员，你只要能轻松地读写一些基本的Python代码就可以了；第二是HTTP程序员">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-11-08T13:12:27.000Z">
<meta property="article:modified_time" content="2019-06-23T13:47:20.000Z">
<meta property="article:author" content="证心">
<meta property="article:tag" content="区块链">
<meta name="twitter:card" content="summary">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">OneKBase</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">归一</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" target="_blank" rel="noopener" href="http://site.onekbase.com">ITEEDU</a>
        
          <a class="main-nav-link" href="/about/">关于</a>
        
      </nav>
      <nav id="sub-nav">
        
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.onekbase.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-blog/arch/blockchain/pythondemo" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/arch/blockchain/pythondemo/" class="article-date">
  <time class="dt-published" datetime="2018-11-08T13:12:27.000Z" itemprop="datePublished">2018-11-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9E%B6%E6%9E%84/">架构</a>►<a class="article-category-link" href="/categories/%E6%9E%B6%E6%9E%84/%E5%8C%BA%E5%9D%97%E9%93%BE/">区块链</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      区块链python示例
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>在开始之前，我们需要做些准备工作，搞清楚一些问题。</p>
<p>什么是区块链？区块链是由不可变的、有顺序记录的区块组成。他们可以包含交易数据、文件数据或者其他你想要记录的数据。不过最重要的是这些区块通过哈希表链接在一起。</p>
<p>什么是散列？散列函数是一个输入值函数，从该输入创建一个确定输入值的输出值。</p>
<p>这篇文章适合谁，首先Python程序员，你只要能轻松地读写一些基本的Python代码就可以了；第二是HTTP程序员，因为我们接下来讲到的区块链，是构建在HTTP上面的，这需要你起码要了解HTTP请求的工作原理。</p>
<p>我需要做什么？首先要确保安装了Python 3.6以上的环境和Flask，此外还需要安装一个碉堡的Requests库。版本信息如下：</p>
<p><code>pip install Flask==0.12.2 requests==2.18.4</code></p>
<h2 id="第一步：创建区块链"><a href="#第一步：创建区块链" class="headerlink" title="第一步：创建区块链"></a>第一步：创建区块链</h2><p>打开你常用的编辑器，我个人比较喜欢PyCharm。创建一个新的文件，命名为 blockchain.py。整个项目，我们都只会用到这一个文件。有不清楚的地方，可以参考源代码。</p>
<p>表示一个区块链</p>
<p>我们将创建一个 Blockchain 类，它的构造函数里创建了一个初始为空的列表（用于存储我们的区块链），和一个存储交易的列表。下边是这个类的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">class Blockchain(object):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.chain = []</span><br><span class="line">        self.current_transactions = []</span><br><span class="line"></span><br><span class="line">    def new_block(self):</span><br><span class="line">        # Creates a new Block and adds it to the chain</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    def new_transaction(self):</span><br><span class="line">        # Adds a new transaction to the list of transactions</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    @staticmethod</span><br><span class="line">    def hash(block):</span><br><span class="line">        # Hashes a Block</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    @property</span><br><span class="line">    def last_block(self):</span><br><span class="line">        # Returns the last Block in the chain</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>

<p>Blockchain参数的作用是管理区块链，也用于存储交易信息和添加区块的方式。</p>
<h3 id="区块到底长什么样？"><a href="#区块到底长什么样？" class="headerlink" title="区块到底长什么样？"></a>区块到底长什么样？</h3><p>每一个区块包含一个索引、一个时间戳、一个交易列表、一个证明（之后更多）和前一个区块的哈希值。</p>
<p>以下是一个区块的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">block = &#123;</span><br><span class="line">    &#x27;index&#x27;: 1,</span><br><span class="line">    &#x27;timestamp&#x27;: 1506057125.900785,</span><br><span class="line">    &#x27;transactions&#x27;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &#x27;sender&#x27;: &quot;8527147fe1f5426f9dd545de4b27ee00&quot;,</span><br><span class="line">            &#x27;recipient&#x27;: &quot;a77f5cdfa2934df3954a5c7c7da5df1f&quot;,</span><br><span class="line">            &#x27;amount&#x27;: 5,</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &#x27;proof&#x27;: 324984774000,</span><br><span class="line">    &#x27;previous_hash&#x27;: &quot;2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里，区块链的原理就很容易理解了：每一个区块包含它自己本身的一些变量，以及前一个区块的哈希值。这一点非常重要，因为哈希值保证了区块链不可篡改的特性。如果一个区块受到攻击哈希值变了，那么后面的所有区块的哈希值都会为之改变。</p>
<p>你可能想，我还是不太理解。没关系，先接着往下看。</p>
<h3 id="在区块上添加交易"><a href="#在区块上添加交易" class="headerlink" title="在区块上添加交易"></a>在区块上添加交易</h3><p>那么，我们怎么在区块上添加交易呢？可以使用new_transaction()参数。使用方法简单、直接，如下面代码所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class Blockchain(object):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    def new_transaction(self, sender, recipient, amount):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Creates a new transaction to go into the next mined Block</span><br><span class="line"></span><br><span class="line">        :param sender: &lt;str&gt; Address of the Sender</span><br><span class="line">        :param recipient: &lt;str&gt; Address of the Recipient</span><br><span class="line">        :param amount: &lt;int&gt; Amount</span><br><span class="line">        :return: &lt;int&gt; The index of the Block that will hold this transaction</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        self.current_transactions.append(&#123;</span><br><span class="line">            &#x27;sender&#x27;: sender,</span><br><span class="line">            &#x27;recipient&#x27;: recipient,</span><br><span class="line">            &#x27;amount&#x27;: amount,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        return self.last_block[&#x27;index&#x27;] + 1</span><br></pre></td></tr></table></figure>

<p>在 new_transaction() 添加交易信息到列表中后，它会返回下一个将被开采区块的索引号，交易信息将被打包到这个区块上。这对稍后提交交易的用户有用。</p>
<h3 id="创建新区块"><a href="#创建新区块" class="headerlink" title="创建新区块"></a>创建新区块</h3><p>在区块链创建完成后，我们需要创建一个创世区块（也就是区块链上的第一个区块）。当然，创世区块也需要被证明，这需要通过PoW的挖矿机制。后边我们会更多的介绍挖矿，这儿就不做过多的介绍了。</p>
<p>除了在构造函数中创建创始区块，我们还需要用new_block()、new_transaction() 和 hash()参数对其进行完善。代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">import json</span><br><span class="line">from time import time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Blockchain(object):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.current_transactions = []</span><br><span class="line">        self.chain = []</span><br><span class="line"></span><br><span class="line">        # Create the genesis block</span><br><span class="line">        self.new_block(previous_hash=1, proof=100)</span><br><span class="line"></span><br><span class="line">    def new_block(self, proof, previous_hash=None):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Create a new Block in the Blockchain</span><br><span class="line">        :param proof: &lt;int&gt; The proof given by the Proof of Work algorithm</span><br><span class="line">        :param previous_hash: (Optional) &lt;str&gt; Hash of previous Block</span><br><span class="line">        :return: &lt;dict&gt; New Block</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        block = &#123;</span><br><span class="line">            &#x27;index&#x27;: len(self.chain) + 1,</span><br><span class="line">            &#x27;timestamp&#x27;: time(),</span><br><span class="line">            &#x27;transactions&#x27;: self.current_transactions,</span><br><span class="line">            &#x27;proof&#x27;: proof,</span><br><span class="line">            &#x27;previous_hash&#x27;: previous_hash or self.hash(self.chain[-1]),</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # Reset the current list of transactions</span><br><span class="line">        self.current_transactions = []</span><br><span class="line"></span><br><span class="line">        self.chain.append(block)</span><br><span class="line">        return block</span><br><span class="line"></span><br><span class="line">    def new_transaction(self, sender, recipient, amount):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Creates a new transaction to go into the next mined Block</span><br><span class="line">        :param sender: &lt;str&gt; Address of the Sender</span><br><span class="line">        :param recipient: &lt;str&gt; Address of the Recipient</span><br><span class="line">        :param amount: &lt;int&gt; Amount</span><br><span class="line">        :return: &lt;int&gt; The index of the Block that will hold this transaction</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        self.current_transactions.append(&#123;</span><br><span class="line">            &#x27;sender&#x27;: sender,</span><br><span class="line">            &#x27;recipient&#x27;: recipient,</span><br><span class="line">            &#x27;amount&#x27;: amount,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        return self.last_block[&#x27;index&#x27;] + 1</span><br><span class="line"></span><br><span class="line">    @property</span><br><span class="line">    def last_block(self):</span><br><span class="line">        return self.chain[-1]</span><br><span class="line"></span><br><span class="line">    @staticmethod</span><br><span class="line">    def hash(block):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Creates a SHA-256 hash of a Block</span><br><span class="line">        :param block: &lt;dict&gt; Block</span><br><span class="line">        :return: &lt;str&gt;</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        # We must make sure that the Dictionary is Ordered, or we&#x27;ll have inconsistent hashes</span><br><span class="line">        block_string = json.dumps(block, sort_keys=True).encode()</span><br><span class="line">        return hashlib.sha256(block_string).hexdigest()</span><br></pre></td></tr></table></figure>

<p>为了方便大家理解，我在上面代码中加了一些注释。到这里，我们就已经对区块链属性有一个全面的了解了。不过我们还是要知道，区块链是怎么创建、怎么开发，以及跟矿工有什么关系。</p>
<h3 id="关于工作量证明-PoW）"><a href="#关于工作量证明-PoW）" class="headerlink" title="关于工作量证明(PoW）"></a>关于工作量证明(PoW）</h3><p>工作证明算法（PoW）的作用，是对区块链上创建或开发新的区块的证明。其背后的核心是：找到一串解决某个数学问题的数字，这个数字必须符合两个条件：第一，难找；第二，很容易被验证（而且是很容易被任何人验证）。</p>
<p>我们来举个非常简单的例子来帮助大家理解。</p>
<p>我们来看一下这个例子，某个整数 x 乘以另外一个数 y ，得到的结果的哈希值必须是以 0 结尾。可以简单表示为：hash(x * y) &#x3D; ac23dc…0。所以，我们的目标是找到满足这个条件的一个 y 值。为了方便理解，我们暂定x&#x3D;5。下面我们就用Python来做这样一个运算：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from hashlib import sha256</span><br><span class="line">x = 5</span><br><span class="line">y = 0  # We don&#x27;t know what y should be yet...</span><br><span class="line">while sha256(f&#x27;&#123;x*y&#125;&#x27;.encode()).hexdigest()[-1] != &quot;0&quot;:</span><br><span class="line">    y += 1</span><br><span class="line">print(f&#x27;The solution is y = &#123;y&#125;&#x27;)</span><br></pre></td></tr></table></figure>

<p>最终，计算结果是 y&#x3D;21。因此，生成的以 0 结尾的哈希值是：</p>
<p><code>hash(5 * 21) = 1253e9373e...5e3600155e860</code></p>
<p>在比特币中，PoW算法被称为Hashcash，原理跟上面例子差不多。矿工们为了能创建一个新区块，铆足劲儿做着上面的数学题（只有胜出者才能添加区块）。一般而言，证明的难度取决于字符串中搜索的字符数量，先找到正确数字的旷工就能够在每笔交易中获得比特币作为奖励。</p>
<p>系统能够很容易验证他们的解决方案。</p>
<h3 id="实现基本的工作量证明"><a href="#实现基本的工作量证明" class="headerlink" title="实现基本的工作量证明"></a>实现基本的工作量证明</h3><p>下面在我们刚刚创建好的区块链上，来实现一个相似的工作量证明算法。规则与上边那个简单的例子相似：</p>
<p>找到一个数字 p ，它和前边一个区块的解决数字进行散列，生成前4位为 0 的哈希值。</p>
<p>下面是具体的Python代码实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">from time import time</span><br><span class="line">from uuid import uuid4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Blockchain(object):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    def proof_of_work(self, last_proof):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Simple Proof of Work Algorithm:</span><br><span class="line">         - Find a number p&#x27; such that hash(pp&#x27;) contains leading 4 zeroes, where p is the previous p&#x27;</span><br><span class="line">         - p is the previous proof, and p&#x27; is the new proof</span><br><span class="line">        :param last_proof: &lt;int&gt;</span><br><span class="line">        :return: &lt;int&gt;</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        proof = 0</span><br><span class="line">        while self.valid_proof(last_proof, proof) is False:</span><br><span class="line">            proof += 1</span><br><span class="line"></span><br><span class="line">        return proof</span><br><span class="line"></span><br><span class="line">    @staticmethod</span><br><span class="line">    def valid_proof(last_proof, proof):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Validates the Proof: Does hash(last_proof, proof) contain 4 leading zeroes?</span><br><span class="line">        :param last_proof: &lt;int&gt; Previous Proof</span><br><span class="line">        :param proof: &lt;int&gt; Current Proof</span><br><span class="line">        :return: &lt;bool&gt; True if correct, False if not.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        guess = f&#x27;&#123;last_proof&#125;&#123;proof&#125;&#x27;.encode()</span><br><span class="line">        guess_hash = hashlib.sha256(guess).hexdigest()</span><br><span class="line">        return guess_hash[:4] == &quot;0000&quot;</span><br></pre></td></tr></table></figure>

<p>我们可以通过修改哈希值前 0 的数量，来调整算法的难度，一般来说，4位已经是足够了。每在哈希值前多加一个0，计算所花费的时间将呈指数倍增加。</p>
<p>到这儿，我们的类基本写好了。下面，我们准备通过 HTTP 请求与其交互。</p>
<h2 id="第二步：创建-API"><a href="#第二步：创建-API" class="headerlink" title="第二步：创建 API"></a>第二步：创建 API</h2><p>我们打算使用 Python 的 Flask 框架，它是一个轻型框架，可以很容易实现端点到Python函数的映射。这样，我们就可以使用 HTTP 请求通过网页访问我们的区块链了。</p>
<p>我们用以下三个方法创建：</p>
<p>&#x2F;transactions&#x2F;new 为一个区块创建一个新的交易；<br>&#x2F;mine 告诉我们的服务器开采一个新的区块；<br>&#x2F;chain 返回完整的 Blockchain 类。</p>
<h3 id="搭建-Flask-框架"><a href="#搭建-Flask-框架" class="headerlink" title="搭建 Flask 框架"></a>搭建 Flask 框架</h3><p>我们的服务器会在区块链网络中形成单个节点。下面来创建一些样板代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">import json</span><br><span class="line">from textwrap import dedent</span><br><span class="line">from time import time</span><br><span class="line">from uuid import uuid4</span><br><span class="line"></span><br><span class="line">from flask import Flask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Blockchain(object):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Instantiate our Node</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"># Generate a globally unique address for this node</span><br><span class="line">node_identifier = str(uuid4()).replace(&#x27;-&#x27;, &#x27;&#x27;)</span><br><span class="line"></span><br><span class="line"># Instantiate the Blockchain</span><br><span class="line">blockchain = Blockchain()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/mine&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def mine():</span><br><span class="line">    return &quot;We&#x27;ll mine a new Block&quot;</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/transactions/new&#x27;, methods=[&#x27;POST&#x27;])</span><br><span class="line">def new_transaction():</span><br><span class="line">    return &quot;We&#x27;ll add a new transaction&quot;</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/chain&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def full_chain():</span><br><span class="line">    response = &#123;</span><br><span class="line">        &#x27;chain&#x27;: blockchain.chain,</span><br><span class="line">        &#x27;length&#x27;: len(blockchain.chain),</span><br><span class="line">    &#125;</span><br><span class="line">    return jsonify(response), 200</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run(host=&#x27;0.0.0.0&#x27;, port=5000)</span><br></pre></td></tr></table></figure>

<p>我们来简单的解释一下上边的代码：</p>
<p>第15行： 实例化我们的节点；加载 Flask 框架。<br>第18行：为我们的节点创建一个随机名称。<br>第21行：实例化 Blockchain 类。<br>第24-26行：创建 &#x2F;mine 端点，这是一个GET请求。<br>第28-30行：创建 &#x2F;transactions&#x2F;new 端点，这是一个 POST 请求，我们将用它来发送数据。<br>第32-38行：创建 &#x2F;chain 端点，它是用来返回整个 Blockchain 类。<br>第40-41行：设置服务器运行端口为 5000。</p>
<h3 id="交易节点"><a href="#交易节点" class="headerlink" title="交易节点"></a>交易节点</h3><p>交易的请求是什么形式呢？下面我们看看用户发送到服务器的一段请求代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> &quot;sender&quot;: &quot;my address&quot;,</span><br><span class="line"> &quot;recipient&quot;: &quot;someone else&#x27;s address&quot;,</span><br><span class="line"> &quot;amount&quot;: 5</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为我们已经写好了将交易打包到区块上的代码，剩下的部分就简单了。只需要调用这个方法，从而实现添加交易的功能。下面是具体代码实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">import json</span><br><span class="line">from textwrap import dedent</span><br><span class="line">from time import time</span><br><span class="line">from uuid import uuid4</span><br><span class="line"></span><br><span class="line">from flask import Flask, jsonify, request</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/transactions/new&#x27;, methods=[&#x27;POST&#x27;])</span><br><span class="line">def new_transaction():</span><br><span class="line">    values = request.get_json()</span><br><span class="line"></span><br><span class="line">    # Check that the required fields are in the POST&#x27;ed data</span><br><span class="line">    required = [&#x27;sender&#x27;, &#x27;recipient&#x27;, &#x27;amount&#x27;]</span><br><span class="line">    if not all(k in values for k in required):</span><br><span class="line">        return &#x27;Missing values&#x27;, 400</span><br><span class="line"></span><br><span class="line">    # Create a new Transaction</span><br><span class="line">    index = blockchain.new_transaction(values[&#x27;sender&#x27;], values[&#x27;recipient&#x27;], values[&#x27;amount&#x27;])</span><br><span class="line"></span><br><span class="line">    response = &#123;&#x27;message&#x27;: f&#x27;Transaction will be added to Block &#123;index&#125;&#x27;&#125;</span><br><span class="line">    return jsonify(response), 201</span><br></pre></td></tr></table></figure>

<h3 id="挖矿节点"><a href="#挖矿节点" class="headerlink" title="挖矿节点"></a>挖矿节点</h3><p>挖矿节点是整个过程中最有趣的部分，它必须要达到三个目的：</p>
<p>计算工作量证明；<br>通过打包交易奖励矿工一个币；<br>通过将新块添加到链中来伪造新块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">from time import time</span><br><span class="line">from uuid import uuid4</span><br><span class="line"></span><br><span class="line">from flask import Flask, jsonify, request</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/mine&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def mine():</span><br><span class="line">    # We run the proof of work algorithm to get the next proof...</span><br><span class="line">    last_block = blockchain.last_block</span><br><span class="line">    last_proof = last_block[&#x27;proof&#x27;]</span><br><span class="line">    proof = blockchain.proof_of_work(last_proof)</span><br><span class="line"></span><br><span class="line">    # We must receive a reward for finding the proof.</span><br><span class="line">    # The sender is &quot;0&quot; to signify that this node has mined a new coin.</span><br><span class="line">    blockchain.new_transaction(</span><br><span class="line">        sender=&quot;0&quot;,</span><br><span class="line">        recipient=node_identifier,</span><br><span class="line">        amount=1,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    # Forge the new Block by adding it to the chain</span><br><span class="line">    previous_hash = blockchain.hash(last_block)</span><br><span class="line">    block = blockchain.new_block(proof, previous_hash)</span><br><span class="line"></span><br><span class="line">    response = &#123;</span><br><span class="line">        &#x27;message&#x27;: &quot;New Block Forged&quot;,</span><br><span class="line">        &#x27;index&#x27;: block[&#x27;index&#x27;],</span><br><span class="line">        &#x27;transactions&#x27;: block[&#x27;transactions&#x27;],</span><br><span class="line">        &#x27;proof&#x27;: block[&#x27;proof&#x27;],</span><br><span class="line">        &#x27;previous_hash&#x27;: block[&#x27;previous_hash&#x27;],</span><br><span class="line">    &#125;</span><br><span class="line">    return jsonify(response), 200</span><br></pre></td></tr></table></figure>

<p>这儿要注意一下，开采区块的接收者是我们节点的地址。在这里完成的大部分工作只是与Blockchain类中的方法进行交互。下面可以开始与我们的区块链交互啦。</p>
<h3 id="第三步：实现与-Blockchain-类交互"><a href="#第三步：实现与-Blockchain-类交互" class="headerlink" title="第三步：实现与 Blockchain 类交互"></a>第三步：实现与 Blockchain 类交互</h3><p>你可以使用普通的 cURL 或者 Postman 通过网络和刚才生成的 API 进行交互。</p>
<p>启动服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python blockchain.py</span><br><span class="line">* Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)</span><br></pre></td></tr></table></figure>
<p>通过向以下地址发送请求，我们可以尝试一下挖矿。</p>
<p><code>http://localhost:5000/mine</code></p>
<p>下面我们通过向下面链接发送post请求，来创建一个新的交易：<br><code>http://localhost:5000/transactions/new</code></p>
<p>请求中要包含我们的交易结构。</p>
<p>如果你用的是cURL，则可以通过下面代码来实现。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X POST -H &quot;Content-Type: application/json&quot; -d &#x27;&#123;</span><br><span class="line"> &quot;sender&quot;: &quot;d4ee26eee15148ee92c6cd394edd974e&quot;,</span><br><span class="line"> &quot;recipient&quot;: &quot;someone-other-address&quot;,</span><br><span class="line"> &quot;amount&quot;: 5</span><br><span class="line">&#125;&#x27; &quot;http://localhost:5000/transactions/new&quot;</span><br></pre></td></tr></table></figure>
<p>完成上面步骤之后，需要重启下服务器。这时候，我挖出了2个区块，获得了3个币的奖励。这里，我们还可以像以下地址发送请求，来对整条链进行检查。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;chain&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;index&quot;: 1,</span><br><span class="line">      &quot;previous_hash&quot;: 1,</span><br><span class="line">      &quot;proof&quot;: 100,</span><br><span class="line">      &quot;timestamp&quot;: 1506280650.770839,</span><br><span class="line">      &quot;transactions&quot;: []</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;index&quot;: 2,</span><br><span class="line">      &quot;previous_hash&quot;: &quot;c099bc...bfb7&quot;,</span><br><span class="line">      &quot;proof&quot;: 35293,</span><br><span class="line">      &quot;timestamp&quot;: 1506280664.717925,</span><br><span class="line">      &quot;transactions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;amount&quot;: 1,</span><br><span class="line">          &quot;recipient&quot;: &quot;8bbcb347e0634905b0cac7955bae152b&quot;,</span><br><span class="line">          &quot;sender&quot;: &quot;0&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;index&quot;: 3,</span><br><span class="line">      &quot;previous_hash&quot;: &quot;eff91a...10f2&quot;,</span><br><span class="line">      &quot;proof&quot;: 35089,</span><br><span class="line">      &quot;timestamp&quot;: 1506280666.1086972,</span><br><span class="line">      &quot;transactions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;amount&quot;: 1,</span><br><span class="line">          &quot;recipient&quot;: &quot;8bbcb347e0634905b0cac7955bae152b&quot;,</span><br><span class="line">          &quot;sender&quot;: &quot;0&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;length&quot;: 3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第四步：形成共识"><a href="#第四步：形成共识" class="headerlink" title="第四步：形成共识"></a>第四步：形成共识</h2><p>终于写到共识了，共识机制是我认为区块链中最有意思的部分。 在上面的步骤中，我们已经创建完成了一个简单的区块链，并且能够实现交易、挖矿等基本功能。 不过，区块链上的节点应该是分散的。 如果它们是分散的，我们究竟如何确保它们记录的都是同一条链？ 这就叫共识问题。如果我们的网络中需要多个节点，我们必须实现共识算法。</p>
<h3 id="注册新节点"><a href="#注册新节点" class="headerlink" title="注册新节点"></a>注册新节点</h3><p>在我们实现共识算法之前，需要解决一个问题：在同一个网络上，让其中一个节点知道它的相邻节点有哪些。每一个节点需要网络上的其他节点进行注册。因此，我们将需要更多的节点：</p>
<p>&#x2F;nodes&#x2F;register 接受URL形式的新节点列表。<br>&#x2F;nodes&#x2F;resolve 实现我们的共识算法，它可以解决任何争议，保证节点具有正确的链。</p>
<p>下面，我们需要修改Blockchain类的结构，以及找到注册节点实现的方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">from urllib.parse import urlparse</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Blockchain(object):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        ...</span><br><span class="line">        self.nodes = set()</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    def register_node(self, address):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Add a new node to the list of nodes</span><br><span class="line">        :param address: &lt;str&gt; Address of node. Eg. &#x27;http://192.168.0.5:5000&#x27;</span><br><span class="line">        :return: None</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        parsed_url = urlparse(address)</span><br><span class="line">        self.nodes.add(parsed_url.netloc)</span><br></pre></td></tr></table></figure>

<p>这儿需要注意一下，set（）函数用来保存节点列表。 它是确保添加的新节点具有幂等性的方法，意思是无论我们使用这个方法添加特定节点多少次，它都只会出现一次。</p>
<h3 id="实现共识算法"><a href="#实现共识算法" class="headerlink" title="实现共识算法"></a>实现共识算法</h3><p>先前提到的，当某个节点与另一个节点的记录不一致时，会「打架」。为了解决这个冲突，我们需要制定一个规则，即最长而有效的链是最有权威性的。换句话说，网络上最长的链就是事实。使用这个算法，我们就可以在我们的网络上达成共识。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Blockchain(object)</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    def valid_chain(self, chain):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Determine if a given blockchain is valid</span><br><span class="line">        :param chain: &lt;list&gt; A blockchain</span><br><span class="line">        :return: &lt;bool&gt; True if valid, False if not</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        last_block = chain[0]</span><br><span class="line">        current_index = 1</span><br><span class="line"></span><br><span class="line">        while current_index &lt; len(chain):</span><br><span class="line">            block = chain[current_index]</span><br><span class="line">            print(f&#x27;&#123;last_block&#125;&#x27;)</span><br><span class="line">            print(f&#x27;&#123;block&#125;&#x27;)</span><br><span class="line">            print(&quot;\n-----------\n&quot;)</span><br><span class="line">            # Check that the hash of the block is correct</span><br><span class="line">            if block[&#x27;previous_hash&#x27;] != self.hash(last_block):</span><br><span class="line">                return False</span><br><span class="line"></span><br><span class="line">            # Check that the Proof of Work is correct</span><br><span class="line">            if not self.valid_proof(last_block[&#x27;proof&#x27;], block[&#x27;proof&#x27;]):</span><br><span class="line">                return False</span><br><span class="line"></span><br><span class="line">            last_block = block</span><br><span class="line">            current_index += 1</span><br><span class="line"></span><br><span class="line">        return True</span><br><span class="line"></span><br><span class="line">    def resolve_conflicts(self):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        This is our Consensus Algorithm, it resolves conflicts</span><br><span class="line">        by replacing our chain with the longest one in the network.</span><br><span class="line">        :return: &lt;bool&gt; True if our chain was replaced, False if not</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        neighbours = self.nodes</span><br><span class="line">        new_chain = None</span><br><span class="line"></span><br><span class="line">        # We&#x27;re only looking for chains longer than ours</span><br><span class="line">        max_length = len(self.chain)</span><br><span class="line"></span><br><span class="line">        # Grab and verify the chains from all the nodes in our network</span><br><span class="line">        for node in neighbours:</span><br><span class="line">            response = requests.get(f&#x27;http://&#123;node&#125;/chain&#x27;)</span><br><span class="line"></span><br><span class="line">            if response.status_code == 200:</span><br><span class="line">                length = response.json()[&#x27;length&#x27;]</span><br><span class="line">                chain = response.json()[&#x27;chain&#x27;]</span><br><span class="line"></span><br><span class="line">                # Check if the length is longer and the chain is valid</span><br><span class="line">                if length &gt; max_length and self.valid_chain(chain):</span><br><span class="line">                    max_length = length</span><br><span class="line">                    new_chain = chain</span><br><span class="line"></span><br><span class="line">        # Replace our chain if we discovered a new, valid chain longer than ours</span><br><span class="line">        if new_chain:</span><br><span class="line">            self.chain = new_chain</span><br><span class="line">            return True</span><br><span class="line"></span><br><span class="line">        return False</span><br></pre></td></tr></table></figure>

<p>其中，valid_chain() 方法是负责校验这一条链是否是有效的，怎么校验呢？遍历每一个区块，验证它们的哈希值和工作量证明。</p>
<p>resolve_conflicts() 是遍历我们所有相邻节点的方法，会下载它们的链，然后使用上述方法去验证它们。如果找到一个有效的链，其长度大于我们的链，就将我们的链条替换为该链。</p>
<p>下面我们在API中，注册两个节点，一个用于添加相邻节点，另一个用于解决冲突：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/nodes/register&#x27;, methods=[&#x27;POST&#x27;])</span><br><span class="line">def register_nodes():</span><br><span class="line">    values = request.get_json()</span><br><span class="line"></span><br><span class="line">    nodes = values.get(&#x27;nodes&#x27;)</span><br><span class="line">    if nodes is None:</span><br><span class="line">        return &quot;Error: Please supply a valid list of nodes&quot;, 400</span><br><span class="line"></span><br><span class="line">    for node in nodes:</span><br><span class="line">        blockchain.register_node(node)</span><br><span class="line"></span><br><span class="line">    response = &#123;</span><br><span class="line">        &#x27;message&#x27;: &#x27;New nodes have been added&#x27;,</span><br><span class="line">        &#x27;total_nodes&#x27;: list(blockchain.nodes),</span><br><span class="line">    &#125;</span><br><span class="line">    return jsonify(response), 201</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/nodes/resolve&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def consensus():</span><br><span class="line">    replaced = blockchain.resolve_conflicts()</span><br><span class="line"></span><br><span class="line">    if replaced:</span><br><span class="line">        response = &#123;</span><br><span class="line">            &#x27;message&#x27;: &#x27;Our chain was replaced&#x27;,</span><br><span class="line">            &#x27;new_chain&#x27;: blockchain.chain</span><br><span class="line">        &#125;</span><br><span class="line">    else:</span><br><span class="line">        response = &#123;</span><br><span class="line">            &#x27;message&#x27;: &#x27;Our chain is authoritative&#x27;,</span><br><span class="line">            &#x27;chain&#x27;: blockchain.chain</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    return jsonify(response), 200</span><br></pre></td></tr></table></figure>

<p>此时，你可以使用不同机器（或使用同一台机器的不同端口）启动不同的节点。 我是使用的同一台机器，在另外一个端口上创建了另一个节点，并将其注册到当前节点。 因此，我有两个节点：http：&#x2F;&#x2F; localhost：5000 和 http：&#x2F;&#x2F; localhost：5001。</p>
<p>完整代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">import json</span><br><span class="line">from textwrap import dedent</span><br><span class="line">from time import time</span><br><span class="line">from uuid import uuid4</span><br><span class="line">from urllib.parse import urlparse</span><br><span class="line">from flask import Flask, jsonify, request</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Blockchain(object):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.chain = []</span><br><span class="line">        self.current_transactions = []</span><br><span class="line"></span><br><span class="line">        self.nodes = set()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        # Create the genesis block</span><br><span class="line">        self.new_block(previous_hash=1, proof=100)</span><br><span class="line"></span><br><span class="line">    def new_block(self, proof, previous_hash=None):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Create a new Block in the Blockchain</span><br><span class="line">        :param proof: &lt;int&gt; The proof given by the Proof of Work algorithm</span><br><span class="line">        :param previous_hash: (Optional) &lt;str&gt; Hash of previous Block</span><br><span class="line">        :return: &lt;dict&gt; New Block</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        block = &#123;</span><br><span class="line">            &#x27;index&#x27;: len(self.chain) + 1,</span><br><span class="line">            &#x27;timestamp&#x27;: time(),</span><br><span class="line">            &#x27;transactions&#x27;: self.current_transactions,</span><br><span class="line">            &#x27;proof&#x27;: proof,</span><br><span class="line">            &#x27;previous_hash&#x27;: previous_hash or self.hash(self.chain[-1]),</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # Reset the current list of transactions</span><br><span class="line">        self.current_transactions = []</span><br><span class="line"></span><br><span class="line">        self.chain.append(block)</span><br><span class="line">        return block</span><br><span class="line"></span><br><span class="line">    def new_transaction(self, sender, recipient, amount):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Creates a new transaction to go into the next mined Block</span><br><span class="line"></span><br><span class="line">        :param sender: &lt;str&gt; Address of the Sender</span><br><span class="line">        :param recipient: &lt;str&gt; Address of the Recipient</span><br><span class="line">        :param amount: &lt;int&gt; Amount</span><br><span class="line">        :return: &lt;int&gt; The index of the Block that will hold this transaction</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        self.current_transactions.append(&#123;</span><br><span class="line">            &#x27;sender&#x27;: sender,</span><br><span class="line">            &#x27;recipient&#x27;: recipient,</span><br><span class="line">            &#x27;amount&#x27;: amount,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        return self.last_block[&#x27;index&#x27;] + 1</span><br><span class="line"></span><br><span class="line">    @property</span><br><span class="line">    def last_block(self):</span><br><span class="line">        return self.chain[-1]</span><br><span class="line"></span><br><span class="line">    @staticmethod</span><br><span class="line">    def hash(block):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Creates a SHA-256 hash of a Block</span><br><span class="line">        :param block: &lt;dict&gt; Block</span><br><span class="line">        :return: &lt;str&gt;</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        # We must make sure that the Dictionary is Ordered, or we&#x27;ll have inconsistent hashes</span><br><span class="line">        block_string = json.dumps(block, sort_keys=True).encode()</span><br><span class="line">        return hashlib.sha256(block_string).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    def proof_of_work(self, last_proof):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Simple Proof of Work Algorithm:</span><br><span class="line">         - Find a number p&#x27; such that hash(pp&#x27;) contains leading 4 zeroes, where p is the previous p&#x27;</span><br><span class="line">         - p is the previous proof, and p&#x27; is the new proof</span><br><span class="line">        :param last_proof: &lt;int&gt;</span><br><span class="line">        :return: &lt;int&gt;</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        proof = 0</span><br><span class="line">        while self.valid_proof(last_proof, proof) is False:</span><br><span class="line">            proof += 1</span><br><span class="line"></span><br><span class="line">        return proof</span><br><span class="line"></span><br><span class="line">    @staticmethod</span><br><span class="line">    def valid_proof(last_proof, proof):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Validates the Proof: Does hash(last_proof, proof) contain 4 leading zeroes?</span><br><span class="line">        :param last_proof: &lt;int&gt; Previous Proof</span><br><span class="line">        :param proof: &lt;int&gt; Current Proof</span><br><span class="line">        :return: &lt;bool&gt; True if correct, False if not.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        guess = f&#x27;&#123;last_proof&#125;&#123;proof&#125;&#x27;.encode()</span><br><span class="line">        guess_hash = hashlib.sha256(guess).hexdigest()</span><br><span class="line">        return guess_hash[:4] == &quot;0000&quot;</span><br><span class="line">    </span><br><span class="line">    def register_node(self, address):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Add a new node to the list of nodes</span><br><span class="line">        :param address: &lt;str&gt; Address of node. Eg. &#x27;http://192.168.0.5:5000&#x27;</span><br><span class="line">        :return: None</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        parsed_url = urlparse(address)</span><br><span class="line">        self.nodes.add(parsed_url.netloc)</span><br><span class="line"></span><br><span class="line">    def valid_chain(self, chain):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Determine if a given blockchain is valid</span><br><span class="line">        :param chain: &lt;list&gt; A blockchain</span><br><span class="line">        :return: &lt;bool&gt; True if valid, False if not</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        last_block = chain[0]</span><br><span class="line">        current_index = 1</span><br><span class="line"></span><br><span class="line">        while current_index &lt; len(chain):</span><br><span class="line">            block = chain[current_index]</span><br><span class="line">            print(f&#x27;&#123;last_block&#125;&#x27;)</span><br><span class="line">            print(f&#x27;&#123;block&#125;&#x27;)</span><br><span class="line">            print(&quot;\n-----------\n&quot;)</span><br><span class="line">            # Check that the hash of the block is correct</span><br><span class="line">            if block[&#x27;previous_hash&#x27;] != self.hash(last_block):</span><br><span class="line">                return False</span><br><span class="line"></span><br><span class="line">            # Check that the Proof of Work is correct</span><br><span class="line">            if not self.valid_proof(last_block[&#x27;proof&#x27;], block[&#x27;proof&#x27;]):</span><br><span class="line">                return False</span><br><span class="line"></span><br><span class="line">            last_block = block</span><br><span class="line">            current_index += 1</span><br><span class="line"></span><br><span class="line">        return True</span><br><span class="line"></span><br><span class="line">    def resolve_conflicts(self):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        This is our Consensus Algorithm, it resolves conflicts</span><br><span class="line">        by replacing our chain with the longest one in the network.</span><br><span class="line">        :return: &lt;bool&gt; True if our chain was replaced, False if not</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        neighbours = self.nodes</span><br><span class="line">        new_chain = None</span><br><span class="line"></span><br><span class="line">        # We&#x27;re only looking for chains longer than ours</span><br><span class="line">        max_length = len(self.chain)</span><br><span class="line"></span><br><span class="line">        # Grab and verify the chains from all the nodes in our network</span><br><span class="line">        for node in neighbours:</span><br><span class="line">            response = requests.get(f&#x27;http://&#123;node&#125;/chain&#x27;)</span><br><span class="line"></span><br><span class="line">            if response.status_code == 200:</span><br><span class="line">                length = response.json()[&#x27;length&#x27;]</span><br><span class="line">                chain = response.json()[&#x27;chain&#x27;]</span><br><span class="line"></span><br><span class="line">                # Check if the length is longer and the chain is valid</span><br><span class="line">                if length &gt; max_length and self.valid_chain(chain):</span><br><span class="line">                    max_length = length</span><br><span class="line">                    new_chain = chain</span><br><span class="line"></span><br><span class="line">        # Replace our chain if we discovered a new, valid chain longer than ours</span><br><span class="line">        if new_chain:</span><br><span class="line">            self.chain = new_chain</span><br><span class="line">            return True</span><br><span class="line"></span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line"># Instantiate our Node</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"># Generate a globally unique address for this node</span><br><span class="line">node_identifier = str(uuid4()).replace(&#x27;-&#x27;, &#x27;&#x27;)</span><br><span class="line"></span><br><span class="line"># Instantiate the Blockchain</span><br><span class="line">blockchain = Blockchain()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/mine&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def mine():</span><br><span class="line">    # We run the proof of work algorithm to get the next proof...</span><br><span class="line">    last_block = blockchain.last_block</span><br><span class="line">    last_proof = last_block[&#x27;proof&#x27;]</span><br><span class="line">    proof = blockchain.proof_of_work(last_proof)</span><br><span class="line"></span><br><span class="line">    # We must receive a reward for finding the proof.</span><br><span class="line">    # The sender is &quot;0&quot; to signify that this node has mined a new coin.</span><br><span class="line">    blockchain.new_transaction(</span><br><span class="line">        sender=&quot;0&quot;,</span><br><span class="line">        recipient=node_identifier,</span><br><span class="line">        amount=1,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    # Forge the new Block by adding it to the chain</span><br><span class="line">    previous_hash = blockchain.hash(last_block)</span><br><span class="line">    block = blockchain.new_block(proof, previous_hash)</span><br><span class="line"></span><br><span class="line">    response = &#123;</span><br><span class="line">        &#x27;message&#x27;: &quot;New Block Forged&quot;,</span><br><span class="line">        &#x27;index&#x27;: block[&#x27;index&#x27;],</span><br><span class="line">        &#x27;transactions&#x27;: block[&#x27;transactions&#x27;],</span><br><span class="line">        &#x27;proof&#x27;: block[&#x27;proof&#x27;],</span><br><span class="line">        &#x27;previous_hash&#x27;: block[&#x27;previous_hash&#x27;],</span><br><span class="line">    &#125;</span><br><span class="line">    return jsonify(response), 200</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/transactions/new&#x27;, methods=[&#x27;POST&#x27;])</span><br><span class="line">def new_transaction():</span><br><span class="line">    values = request.get_json()</span><br><span class="line"></span><br><span class="line">    # Check that the required fields are in the POST&#x27;ed data</span><br><span class="line">    required = [&#x27;sender&#x27;, &#x27;recipient&#x27;, &#x27;amount&#x27;]</span><br><span class="line">    if not all(k in values for k in required):</span><br><span class="line">        return &#x27;Missing values&#x27;, 400</span><br><span class="line"></span><br><span class="line">    # Create a new Transaction</span><br><span class="line">    index = blockchain.new_transaction(values[&#x27;sender&#x27;], values[&#x27;recipient&#x27;], values[&#x27;amount&#x27;])</span><br><span class="line"></span><br><span class="line">    response = &#123;&#x27;message&#x27;: f&#x27;Transaction will be added to Block &#123;index&#125;&#x27;&#125;</span><br><span class="line">    return jsonify(response), 201</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/chain&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def full_chain():</span><br><span class="line">    response = &#123;</span><br><span class="line">        &#x27;chain&#x27;: blockchain.chain,</span><br><span class="line">        &#x27;length&#x27;: len(blockchain.chain),</span><br><span class="line">    &#125;</span><br><span class="line">    return jsonify(response), 200</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/nodes/register&#x27;, methods=[&#x27;POST&#x27;])</span><br><span class="line">def register_nodes():</span><br><span class="line">    values = request.get_json()</span><br><span class="line"></span><br><span class="line">    nodes = values.get(&#x27;nodes&#x27;)</span><br><span class="line">    if nodes is None:</span><br><span class="line">        return &quot;Error: Please supply a valid list of nodes&quot;, 400</span><br><span class="line"></span><br><span class="line">    for node in nodes:</span><br><span class="line">        blockchain.register_node(node)</span><br><span class="line"></span><br><span class="line">    response = &#123;</span><br><span class="line">        &#x27;message&#x27;: &#x27;New nodes have been added&#x27;,</span><br><span class="line">        &#x27;total_nodes&#x27;: list(blockchain.nodes),</span><br><span class="line">    &#125;</span><br><span class="line">    return jsonify(response), 201</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/nodes/resolve&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def consensus():</span><br><span class="line">    replaced = blockchain.resolve_conflicts()</span><br><span class="line"></span><br><span class="line">    if replaced:</span><br><span class="line">        response = &#123;</span><br><span class="line">            &#x27;message&#x27;: &#x27;Our chain was replaced&#x27;,</span><br><span class="line">            &#x27;new_chain&#x27;: blockchain.chain</span><br><span class="line">        &#125;</span><br><span class="line">    else:</span><br><span class="line">        response = &#123;</span><br><span class="line">            &#x27;message&#x27;: &#x27;Our chain is authoritative&#x27;,</span><br><span class="line">            &#x27;chain&#x27;: blockchain.chain</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    return jsonify(response), 200</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run(host=&#x27;0.0.0.0&#x27;, port=5000)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后，我在第二个节点上挖出了一些新的区块，以确保第二个节点的链条比第一个节点的链条更长。 之后，我在第一个节点上调用 GET &#x2F; nodes &#x2F; resolve，使其中链通过共识算法被第二个节点的链条取代。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.onekbase.com/blog/arch/blockchain/pythondemo/" data-id="clhlnylee005xojuphsnt4lz0" data-title="区块链python示例" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag">区块链</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/arch/crypto/bouncycastle/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          【密码术】bouncycastle 轻量级密码术包
        
      </div>
    </a>
  
  
    <a href="/blog/plang/scala/fold/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">【scala】fold算子示例：字每记数</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/explain/">【置顶】公告</a>
          </li>
        
          <li>
            <a href="/blog/tools/maven/dn-cst-maven-archtype/">开发一个maven脚手架</a>
          </li>
        
          <li>
            <a href="/blog/nosql/neo4j/neo4jindustrystock/">neo4j创建行业与股票关系</a>
          </li>
        
          <li>
            <a href="/blog/nosql/neo4j/neo4jindustry/">neo4j创建三级行业关系</a>
          </li>
        
          <li>
            <a href="/blog/nosql/neo4j/neo4jtimeline/">neo4j创建时间线</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA-WEB/">JAVA WEB</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA-WEB/Spring-Boot/">Spring Boot</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB%E5%BC%80%E5%8F%91/">WEB开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/maven/">maven</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nosql/">nosql</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/nosql/MongoDB/">MongoDB</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9F%BA%E7%A1%80/">基础</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9F%BA%E7%A1%80/%E5%AD%97%E7%AC%A6%E9%9B%86/">字符集</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/spark/">spark</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/Emacs/">Emacs</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/GIT/">GIT</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/VIM/">VIM</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%87%AA%E5%88%B6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">自制操作系统</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/">架构</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/SSO/">SSO</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/%E4%B8%80%E8%87%B4%E6%80%A7/">一致性</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/">任务调度</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/%E5%8C%BA%E5%9D%97%E9%93%BE/">区块链</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/">反向代理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/%E5%AF%86%E7%A0%81%E6%9C%AF/">密码术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/JMS/">JMS</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/%E7%BB%84%E4%BB%B6/">组件</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">负载均衡</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/">知识体系</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/">排序</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E6%A0%91%E7%AE%97%E6%B3%95/">树算法</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C%E8%AF%AD%E8%A8%80/">C语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/JAVA/">JAVA</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/JAVA/BASE/">BASE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/JAVA/IO/">IO</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/JAVA/JAVA8/">JAVA8</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/JAVA/NIO/">NIO</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/JAVA/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/">线程安全</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Lisp/">Lisp</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Lisp/Common-Lisp/">Common Lisp</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Scala/">Scala</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/javascript/">javascript</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/AOP/" style="font-size: 10.5px;">AOP</a> <a href="/tags/ASCII%E7%A0%81/" style="font-size: 10px;">ASCII码</a> <a href="/tags/ActiveMQ/" style="font-size: 11px;">ActiveMQ</a> <a href="/tags/Ajax/" style="font-size: 10px;">Ajax</a> <a href="/tags/BAT%E8%84%9A%E6%9C%AC/" style="font-size: 10px;">BAT脚本</a> <a href="/tags/CAP/" style="font-size: 10px;">CAP</a> <a href="/tags/CAS/" style="font-size: 10.5px;">CAS</a> <a href="/tags/Common-Lisp/" style="font-size: 13.5px;">Common Lisp</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 10.5px;">C语言</a> <a href="/tags/Eclipse/" style="font-size: 11px;">Eclipse</a> <a href="/tags/Emacs/" style="font-size: 16.5px;">Emacs</a> <a href="/tags/Emmet/" style="font-size: 10px;">Emmet</a> <a href="/tags/GIT/" style="font-size: 10px;">GIT</a> <a href="/tags/HttpClient/" style="font-size: 12.5px;">HttpClient</a> <a href="/tags/IPFS/" style="font-size: 10px;">IPFS</a> <a href="/tags/JAVA/" style="font-size: 20px;">JAVA</a> <a href="/tags/JAVA-IO/" style="font-size: 15.5px;">JAVA IO</a> <a href="/tags/JAVA-NIO/" style="font-size: 17px;">JAVA NIO</a> <a href="/tags/JAVA-WEB/" style="font-size: 10.5px;">JAVA WEB</a> <a href="/tags/JAVA8/" style="font-size: 13.5px;">JAVA8</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Lisp/" style="font-size: 12px;">Lisp</a> <a href="/tags/Markdown/" style="font-size: 10.5px;">Markdown</a> <a href="/tags/MongoDB/" style="font-size: 18px;">MongoDB</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/Scala/" style="font-size: 11px;">Scala</a> <a href="/tags/Shiro/" style="font-size: 10px;">Shiro</a> <a href="/tags/Spring-Boot/" style="font-size: 10px;">Spring Boot</a> <a href="/tags/Spring-MVC/" style="font-size: 10px;">Spring MVC</a> <a href="/tags/UML/" style="font-size: 10px;">UML</a> <a href="/tags/VIM/" style="font-size: 16px;">VIM</a> <a href="/tags/WEB%E5%BC%80%E5%8F%91/" style="font-size: 11px;">WEB开发</a> <a href="/tags/XML/" style="font-size: 10.5px;">XML</a> <a href="/tags/archtype/" style="font-size: 10px;">archtype</a> <a href="/tags/azkaban/" style="font-size: 10.5px;">azkaban</a> <a href="/tags/hadoop/" style="font-size: 13px;">hadoop</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/hive/" style="font-size: 10px;">hive</a> <a href="/tags/javascript/" style="font-size: 14px;">javascript</a> <a href="/tags/jquery/" style="font-size: 10px;">jquery</a> <a href="/tags/linux/" style="font-size: 13px;">linux</a> <a href="/tags/maven/" style="font-size: 12px;">maven</a> <a href="/tags/nosql/" style="font-size: 18.5px;">nosql</a> <a href="/tags/nosql-neo4j/" style="font-size: 11.5px;">nosql neo4j</a> <a href="/tags/openssl/" style="font-size: 11px;">openssl</a> <a href="/tags/servlet/" style="font-size: 11px;">servlet</a> <a href="/tags/spark/" style="font-size: 12px;">spark</a> <a href="/tags/spring/" style="font-size: 10px;">spring</a> <a href="/tags/webservice/" style="font-size: 11px;">webservice</a> <a href="/tags/%E4%B8%80%E8%87%B4%E6%80%A7/" style="font-size: 11.5px;">一致性</a> <a href="/tags/%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/" style="font-size: 10.5px;">任务调度</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 10px;">分布式</a> <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" style="font-size: 10px;">区块链</a> <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="font-size: 17.5px;">大数据</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" style="font-size: 10px;">字符编码</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E9%9B%86/" style="font-size: 12.5px;">字符集</a> <a href="/tags/%E5%AE%A1%E8%AE%A1/" style="font-size: 10px;">审计</a> <a href="/tags/%E5%AF%86%E7%A0%81%E6%9C%AF/" style="font-size: 14.5px;">密码术</a> <a href="/tags/%E5%B0%BE%E9%80%92%E5%BD%92/" style="font-size: 10px;">尾递归</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 12px;">并发</a> <a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size: 14px;">排序</a> <a href="/tags/%E6%91%98%E8%A6%81%E7%AE%97%E6%B3%95/" style="font-size: 10px;">摘要算法</a> <a href="/tags/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/" style="font-size: 10.5px;">数字签名</a> <a href="/tags/%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6/" style="font-size: 10px;">数字证书</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 18.5px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/" style="font-size: 10px;">数据权限</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size: 11.5px;">杂谈</a> <a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 13.5px;">架构</a> <a href="/tags/%E6%A0%91%E7%AE%97%E6%B3%95/" style="font-size: 14px;">树算法</a> <a href="/tags/%E6%AD%A3%E8%A7%84%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 10px;">正规表达式</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 10px;">消息队列</a> <a href="/tags/%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/" style="font-size: 12px;">知识体系</a> <a href="/tags/%E7%A5%9E%E5%99%A8/" style="font-size: 12px;">神器</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 18.5px;">算法</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/" style="font-size: 19px;">线程安全</a> <a href="/tags/%E8%87%AA%E5%88%B6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 12.5px;">自制操作系统</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 19.5px;">设计模式</a> <a href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" style="font-size: 13px;">负载均衡</a> <a href="/tags/%E9%94%81/" style="font-size: 11px;">锁</a>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 证心<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a target="_blank" rel="noopener" href="http://site.onekbase.com" class="mobile-nav-link">ITEEDU</a>
  
    <a href="/about/" class="mobile-nav-link">关于</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>