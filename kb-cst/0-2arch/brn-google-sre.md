# google-sre 

# doc

## 序言

有统计显示， 一个软件系统的40%～90% 的花销其实是花在开发建设完成之后不断维护过程中的

站点可靠性工程师（ SRE,Site Reliability Engineering）

SRE 专注于对其负责的软件系统架构设计、 运维流程的不断优化， 让这些大型软件系统运行得更可靠， 扩展性更好， 能更有效地利用资源。

对中型企业来说， 企业内部可能已经有这样的一组人在做着与SRE非常类似的工作。 这些人可能并不叫 SRE 这个名字， 甚至可能没有受到管理层的重视。 在这样的企业中， 提高可靠性最好的办法往往就是去认可这些人的工作， 并配备足够的激励机制。

## 第1章 介绍

传统的研发团队和运维团队这两个部门的目标从本质上来说是互相矛盾的。在现实生活中， 公司内部这两股力量只能用最传统的政治斗争方式来保障各自的利益。

SRE团队通过雇佣软件工程师， 创造软件系统来维护系统运行以替代传统模型中的人工操作。

每个SRE团队里基本上有两类工程师。

第一类， 团队中 50%～60% 是标准的软件工程师， 具体来讲，就是那些能够正常通过Google软件工程师招聘流程的人。 第二类， 其他40%～50% 则是一些基本满足Google软件工程师标准（ 具备85%～
99% 所要求的技能） ， 但是同时具有一定程度的其他技术能力的工程师。

有如下特点：
1. 对重复性、 手工性的操作有天然的排斥感。
2. 有足够的技术能力快速开发出软件系统以替代手工操作。

Google为整个SRE团队所做的所有传统运维工作设立了一个50%的上限值。

SRE团队要承担以下几类职责： 可用性改进， 延迟优化， 性能优化， 效率优化， 变更管理， 监控， 紧急事务处理以及容量规划与管理。

Google SRE的几个核心方法论：

1.  确保长期关注研发工作
2.  在保障服务SLO的前提下最大化迭代速度
3.  监控系统
4.  应急事件处理：
    -   通过事先预案并且将最佳方法记录在“运维手册（ playbook）
        ”上通常可以使MTTR 降低3倍以上。
    -   Google SRE将大部分工作重心放在“运维手册”的维护上
5.  变更管理：大概 70% 的生产事故由某种部署的变更而触发
    -   采用渐进式发布机制
    -   迅速而准确地检测到问题的发生
    -   当出现问题时， 安全迅速地回退改动
6.  需求预测和容量规划：SRE应该主导容量规划的过程
    -   必须有一个准确的自然增长需求预测模型
    -   规划中必须有准确的非自然增长的需求来源的统计
    -   必须有周期性压力测试
7.  资源部署
8.  效率与性能

Google SRE代表了对行业现存管理大型复杂服务的最佳实践的一个重要突破。

## 第2章 SRE视角

### 研发环境

## 第3章 拥抱风险

事实证明， 超过一定值后， 再提高可靠性对于一项服务（ 和它的用户） 来说， 结果可能会更差而不是更好！ 极端的可靠性会带来成本的大幅提升： 过分追求稳定性限制了新功能的开发速度和将产品交付给用户的速度， 并且很大程度地增加了成本， 这反过来又减少了一个团队可以提供的新功能的数量。

在构建系统的过程中， 可靠性进一步提升的成本并不是线性增加的—可靠性的下一个改进可能比之前的改进成本增加100倍。

1.  冗余物理服务器/计算资源的成本
2.  机会成本

我们会努力提高一项服务的可靠性， 但不会超过该服务需要的可靠性。

工作内容：可靠性、增加新功能、清理技术债务、降低运维成本

### 度量服务的风险度量服务的风险

Google标准做法是通过一个客观的指标来体现一个待优化的系统属性。 将所有的潜在因素缩减为一个单一的性能指标， 可能不是一件能够立刻解决的事情。

主要关注计划外停机这个指标。

- 计划外停机：可用性=系统正常运行时间/（ 系统正常运行时间+停机时间）
- 请求成功率：可用性=成功请求数/总的请求数

通过寻找、 跟踪和调整重要的、 不可避免的偏差来使服务达到一个高层次的可用性目标。

风险：评价服务风险容忍度时， 有许多需要考虑的因素。 如下所示：
● 需要的可用性水平是什么？
● 不同类型的失败对服务有不同的影响吗？
● 我们如何使用服务成本来帮助在风险曲线上定位这个服务？
● 有哪些其他重要的服务指标需要考虑？

可用性：服务的可用性目标通常取决于它提供的功能， 以及这项服务在市场上是如何定位的。 下面列出了要考虑的一些问题：
● 用户期望的服务水平是什么？
● 这项服务是否直接关系到收入（ 我们的收入或我们的客户的收入） ？
● 这是一个有偿服务， 还是免费服务？
● 如果市场上有竞争对手， 那些竞争对手提供的服务水平如何？
● 这项服务是针对消费者还是企业的？


成本：在为每一项服务确定可用性目标时， 可以考虑如下的问题：
● 构建和运维可用性再多一个“9”的系统， 收益会增加多少？
● 额外的收入是否能够抵消为了达到这一可靠性水平所付出的成本？

错误预算

错误预算提供了一个明确的、 客观的指标来决定服务在一个单独的季度中能接受多少不可靠性。 这个指标在SRE与产品研发部门的谈判中将政治因素排除。

● 产品管理层定义一个SLO， 确定一项服务在每个季度预计的正常运行时间。
● 实际在线时间是通过一个中立的第三方来测算的： 我们的监控系统。
● 这两个数字的差值就是这个季度中剩余的不可靠性预算。
● 只要测算出的正常在线时间高于SLO， 也就是说， 只要仍然有剩余的错误预算， 就可以发布新的版本。

错误预算的主要好处就是它能够激励产品研发和SRE一起找出创新和可靠性之间合理的平衡点。

如果网络中断或者数据中心发生故障影响了SLO， 怎么办？ 这样的事件也会给错误预算带来不良的影响， 会使本季度剩余部分的发布将会减少。 整个团队会支持这种发布频率的降低， 因为每个人都有义
务保障服务正常运行。

关键点

● 管理服务的可靠性主要在于管理风险， 而且管理风险的成本可能很高。
● 100%可能永远都不是一个正确的可靠性目标： 不仅是不可能实现的， 而且它通常比一项服务的用户期望的可靠性大得多。 我们要将服务风险和愿意承担的业务风险相匹配。
● 错误预算在SRE和产品研发团队之间调整激励， 同时强调共同责任。 错误预算使得讨论发布速率更容易， 同时可有效地减少任何关于事故的讨论。 这样， 多个团队可以毫无怨言地对生产环境风险度达
成一致。



## 第4章 服务质量目标

服务质量指标（SLI） 、 服务质量目标（SLO） ， 以及服务质量协议（SLA）

SLI是指服务质量指标（ indicator） —该服务的某项服务质量的一个具体量化指标。

大部分服务都将请求延迟—处理请求所消耗的时间—作为一个关键SLI。 其他常见的SLI包括错误率（ 请求处理失败的百分比） 、 系统吞吐量（ 每秒请求数量） 等。

可用性（availability） 是另外一个SRE重视的SLI， 代表服务可用时间的百分比。 该指标通常利用“格式正确的请求处理成功的比例”来定义， 有时也称为服务产出（ yield） 。

SLO是服务质量目标（ Objective） ： 服务的某个SLI的目标值，或者目标范围。 SLO的定义是SLI≤目标值， 或者范围下限≤SLI≤范围上限。

每个季度， 如果真实故障没有将可用性指标降低到SLO之下， SRE会有意安排一次可控的故障， 将服务停机。 利用这种方法，我们可以很快找出那些对Chubby全球服务的不合理依赖， 强迫服务的
负责人尽早面对这类分布式系统的天生缺陷。

如何来识别哪些指标对服务是最重要的呢？

不应该将监控系统中的所有指标都定义为SLI； 只有理解用户对系统的真实需求才能真正决定哪些指标是否有用。

● 用户可见的服务系统:可用性、 延迟， 以及吞吐量
● 存储系统通常强调： 延迟、 可用性和数据持久性。
● 大数据系统: 吞吐量和端到端延迟
● 所有的系统都应该关注： 正确性。是否返回了正确的回复， 是否读取了正确的数据， 或者进行了正确的数据分析操作。 正确性是系统健康程度的一个重要指标， 但是它更关注系统内部的数据， 而不是系统本身， 所以这通常不是SRE直接负责的。

大部分指标都应该以“分布”， 而不是平均值来定义。 

通过公布SLO可以设置用户对系统行为的预期。
- 留出一定的安全区
- 实际SLO也不要过高：可以采取对一些请求限速， 或者限制系统在低负载情况下也不会速度过快的手段

## 第5章 减少琐事

如果系统正常运转中需要人工干预， 应该将此视为一种Bug。

琐事就是运维服务中手动性的， 重复性的，可以被自动化的， 战术性，
没有持久价值的工作。

## 第6章 分布式系统的监控

## 第33章 其他行业经验

愿望不是一个策略

### 灾难预案与演习

-   确保系统按我们预想的方式应对故障
-   寻找系统中未预料到的弱点
-   寻找其他提高系统鲁棒性的方式来避免事故发生

清单

1.  从组织架构层面坚持不懈地对安全进行关注：每次管理会议都是以安全讨论开头
2.  关注任何细节：核动力海军对日常常规维护非常重视
3.  冗余容量
4.  模拟以及进行线上灾难演习
5.  培训与考核：培训与考核在涉及人身安全的行业极为重要
6.  超乎寻常地关注对细节要求的收集与系统的设计：构建新的国防设备甚至需要一整年的设计过程， 最后的实际编码过程只需要三周
7.  纵深防御：核反应堆整个系统设计时加入了多层防护机制

### 书写事后总结的文化

“对事不对人”的事后总结理念

1.  究竟发生了什么
2.  响应的有效程度
3.  下次是否可以采用其他方案解决问题
4.  如何确保这次故障不会再次发生

### 自动化与降低日常运维负载

一个自动化的对输入数据的正确性检查是第一个改进： 如果操作者输入了超出预期范围的数字， 自动化程序会立刻自动提出警告。

### 结构化的、 理智的决策

1.  某项决策的基本方向是事先决定的， 而不是事后得出的。
2.  决策时考虑的信息源是清楚的。
3.  任何假设都应该明确说明。
4.  数据驱动决策要优于情感驱动的决策、 直觉驱动的决策， 以及资深人士的意见。

SRE同时用以下信息作为团队内部的基础要求

1.  每个人都为服务的用户负责。
2.  每个成员都能够根据可用的数据找出执行方案。

某些行业使用“如果没有坏， 就永远不要试着修复它”这种理念来进行决策

## 第34章 结语

当组建团队或者构建系统时， 最理想的情况是制定一系列通用的基本规则和公理。
