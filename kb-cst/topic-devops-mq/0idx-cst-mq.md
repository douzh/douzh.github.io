# MQ主题

消息队列在实际应用中常用的使用场景（优点）：

-   异步处理
-   应用解耦
-   流量削锋
-   消息通讯

- ActiveMQ，性能不是很好，因此在高并发的场景下，直接被pass掉了。
- RabbitMQ，erlang 语言阻止了大量工程师去深入研究和掌控它，比较稳定的支持，活跃度也高，可视化的管理界面比较友好；
- RocketMQ，高性能、满足可靠性、分布式事物、支持水平扩展、上亿级别的消息堆积、主从之间的切换等等
- Kafka，大数据领域的实时计算、日志采集等场景，业务场景支持少

中小型公司，技术实力较为一般，技术挑战不是特别高，用 RabbitMQ 是不错的选择；大型公司，基础架构研发实力较强，用 RocketMQ 是很好的选择。

- [[2dn-cst-kafka]]
- [[2dn-cst-rabbitmq-base]]
- [[2dn-cst-rocketmq-aliyun]]
- [[2dn-cst-rocketmq-base]]
- [[2dn-cst-rocketmq-best]]
- [[2dn-cst-rocketmq-console]]

## rocketmq

<https://rocketmq.apache.org/>

### best

-   一个功能尽可能用一个Topic，而消息子类型则可以用tags来标识。
-   每个消息映射到业务的唯一标识并设置到keys字段，方便将来定位消息丢失问题。
-   send同步方法发送失败时，则尝试将消息存储到db，然后由后台线程定时重试，确保消息一定到达Broker。
-   RocketMQ 无法避免消息重复，务必要在业务层面进行去重处理。
-   几种修改消费并行度的方法：增加 Consumer 实例数量，提高单个 Consumer 的消费并行线程

broker

-   Broker 角色分为 ASYNC~MASTER~（异步主机）、SYNC~MASTER~（同步主机）以及SLAVE（从机）。
-   如果对消息的可靠性要求比较严格，可以采用 SYNC~MASTER加SLAVE的部署方式~。
-   如果对消息可靠性要求不高，可以采用ASYNC~MASTER加SLAVE的部署方式~。
-   如果只是测试方便，则可以选择仅ASYNC~MASTER或仅SYNCMASTER的部署方式~。
-   SYNC~FLUSH~（同步刷新）相比于ASYNC~FLUSH~（异步处理）会损失很多性能，但是也更可靠，所以需要根据实际的业务场景做好权衡。

### 使用逻辑

消息流转：生产者-\>Topic-\>消费者

生产者：

1.  分组：生产组
2.  目标：Topic:Tag

Topic:

1.  所属：集群、broker
2.  队列：每个broker上的读写队列
3.  订阅组：绑定的消费组

消费者：

1.  消费组：实现同一组不重复消费
2.  Topic：订阅Topic
3.  Selector: 过滤同一Topic的消息

**一个消息只能输出到一个Topic，可以被多个消费组订阅**

一个Topic在多个broker上分布有多个queue，消费者订阅最终订阅到queue上。

特殊场景：

用同一个topic向1000个店分发任务，不同的店订阅自己的任务。

方式一：使用广播方式，每个店会收到所有任务，通过自己的ID进行过滤

方式二：使用普通消息，每个店创建自己的group，订阅自己的tag

## rabbitmq

<https://www.rabbitmq.com/>

可使用模拟器做配制模拟：http://tryrabbitmq.com/

<span class="spurious-link"
target="assets/1601818022-b08ad7bdc438cda53c9da9ab548b7c4f.jpg">*assets/1601818022-b08ad7bdc438cda53c9da9ab548b7c4f.jpg*</span>

1.  新建一个exchange，分为direct、fanout、topic三类
2.  新建queue，绑定exchange
3.  connection和channel在连接消费者时可以看到

publisher的一个消息只能发给一个exchange，一个queue可以绑定多个exchange。

## kafka

-   没有消息过滤的语义，可以采取多个Topic的方式达到过滤的目的。
-   没有消息广播的语义，可以通过创建不同的Group来模拟实现。
-   没有列信队列，可以将失败消息转到一个TOPIC模拟实现。
-   可以接入logstash 和 filebeat


[//begin]: # "Autogenerated link references for markdown compatibility"
[2dn-cst-kafka]: 2dn-cst-kafka.md "kafka"
[2dn-cst-rabbitmq-base]: 2dn-cst-rabbitmq-base.md "rabbitmq"
[dn-cst-rocketmq-base]: dn-cst-rocketmq-base.md "Rocketmq介绍"
[dn-cst-rocketmq-best]: dn-cst-rocketmq-best.md "Rocketmq最佳实践"
[dn-cst-rocketmq-console]: dn-cst-rocketmq-console.md "rocketmq-console控制台"
[//end]: # "Autogenerated link references"