---
title: Lisp macro宏的本质
date: 2015-10-31 16:46:15
tags: 
 - Lisp
categories: 
 - 编程语言
 - Lisp
---
本故事引自《实用Common Lisp编程》第8章：如何自定义宏。

很久以前，有一个由Lisp程序员们所组成的公司。那个年代相当久远，所以Lisp还没有宏，每次，任何不能用函数来定义或是用特殊操作符来完成的亊情都不得不完全通过手写来实现，这带来了很大的不便。不幸的是，这个公司的程序员们虽然杰出却非常懶惰。在他们的程序中，当需要编写大量单调乏味的代码时，他们往往会写下一个注释来描述想要在该位罝上编写的代码。更不幸的是，由于很懒情，他们也很讨厌回过头去实际编写那些注释所描述的代码。不久，这个公司就有了一大堆无法运行的程序，因为它们全都是代表着尚需编写代码的注释。

走投无路之下，老板雇用了一个初级程序员Mac。他的工作就是找到这些注释，编写所需的代码，然后再用其替换掉程序中的注释。Mac从未运行过这些程序，程序尚未完成，他当然运行不了。但就算这些程序完成了，不知道该用怎样的输入来运行它们。因此，他只是基于注释的内容来编写他的代码，再将其发还给最初的程序员。

在Mac的帮助下，不久之后，所有的程序都完成了，公司通过销售它们赚了很多钱，并用这些钱将其程序员团队扩大了一倍。但不知为何，没有人想到要雇用其他人来帮助Mac。很快他就开始单枪匹马地同时协助几十个程序员了。为了避免将他所有的时间都花在捜索裸代码的注释上，Mac对程序员们使用的编译器做了一个小小的更改。从那以后，只要编译器遇到一个注释，它就会将注释以电子邮件的形式发给他并等待他将替换的代码传送回来。然而，就算有了这个变化，Mac也很难跟上程序员的进度。他尽可能小心地工作，伹有时，尤其是当注释不够清楚时，他会犯错误。

不过程序员们注意到了，他们将注释写得越精确，Mac就越有可能发回正确的代码。一天，一个花费大量时间用文字来描述他想要的代码的程序员，在他的注释里写入了一个可以生成他想要的代码的Lisp程序，这对Mac来说很简单，他只要运行这个程序并将结果发给编译器就好了。

接下来又出现了一种创新。有一个程序员在他程序的开始处写了一段备注，其中含有一个函数定义以及另一个注释，该注释为：“Mac，不要在这里写任何代码，但要把这个函数留给以后使用，我将在我的其他一些注释里用到它。”同一个程序里还有如下的注释：“Mac,将这个注释替换成用符号x和y作为参数来运行上面提到的那个函数所得到的结果。”

这项技术在几天里就迅速流行起来，多数程序都含有数十个注释，它们定义了那些只被其他注释中的代码所使用的函数。为了使Mac更容易地辨别那些只含有定义而不必立即回复的注释，程序员们用一个标准前缀来标记它们：“给Mac的定义，仅供阅读。”（Definition for Mac, Readonly.)由于程序员们仍然很懶情，这个写法很快简化成“DEF. MAC. R/O”，接着又被简化为“DEFMACRO”。

不久以后，这些給Mac的注释中再没有实际可读的英语了。Mac每天要做的亊情就是阅读并反馈那些来自编译器的含有DEFMACRO注释的电子邮件，以及调用那些DEFMACRO里所定义的函数。由于注释中的Lisp程序做了所有实际的工作，跟上这些电子邮件的进度完全没有问题。

Mac手头上突然有了大量时间，可以坐在他的办公室里做关于白色沙滩，蓝色海水和鸡尾酒的白日梦了，几个月以后，程序员们意识到已经很长时间没人见过Mac了。当他们去他的办公室时，发现 所有东西上都积了薄薄的一层灰，一个桌子上还放着几本热带地区的旅行手册，而电脑则是关着的。但是编译器仍在正常工作，这怎么可能？看起来Mac对编译器做了最后一个修改：现在不需要用电子邮件将注释发给Mac了，编译器会将那些DEFMACRO中所定义的函数保存下来，并在其被其他注释调用时运行它们。程序员们觉得没有理由吿诉老板Mac不再来办公室了，因此直到今天，Mac还领若薪水，并且时不时地会从某个热带地区给程序员们发一张明信片。